async function fetchJSON(u){const r=await fetch(u);return r.json()}
function renderTable(t,rows,cols){const b=t.querySelector('tbody');b.innerHTML='';rows.forEach(r=>{const tr=document.createElement('tr');cols.forEach(c=>{const td=document.createElement('td');const v=r[c]??'';if(c==='dominio'&&v){const a=document.createElement('a');a.href='https://'+v;a.target='_blank';a.textContent=v;a.className='link';td.appendChild(a)}else{td.textContent=v}tr.appendChild(td)});b.appendChild(tr)})}
function setMetrics(m){const mp=document.getElementById('m-prefeituras');const mo=document.getElementById('m-orgaos');const ms=document.getElementById('m-ssl');const mo2=document.getElementById('m-oportunidades');const ma=document.getElementById('m-auditorias');if(mp)mp.textContent=m.prefeituras??0;if(mo)mo.textContent=m.orgaos??0;if(ms)ms.textContent=m.ssl_scans??0;if(mo2)mo2.textContent=m.oportunidades??0;if(ma)ma.textContent=m.auditorias??0}
function setBadges(m){const bOrgaos=document.getElementById('badge-orgaos');const bOpps=document.getElementById('badge-opps');const bSsl=document.getElementById('badge-ssl');const bAud=document.getElementById('badge-aud');if(bOrgaos)bOrgaos.textContent=(m.orgaos??0);if(bOpps)bOpps.textContent=(m.oportunidades??0);if(bSsl)bSsl.textContent=(m.ssl_scans??0);if(bAud)bAud.textContent=(m.auditorias??0)}
function initTheme(){const k='sv-theme';const sKey='sv-settings';const b=document.body;const v=localStorage.getItem(k)||'light';b.classList.remove('theme-light','theme-dark');b.classList.add(v==='dark'?'theme-dark':'theme-light');const s=JSON.parse(localStorage.getItem(sKey)||'{}');if(s.accent)document.documentElement.style.setProperty('--accent',s.accent);if(s.accent2)document.documentElement.style.setProperty('--accent-2',s.accent2);const brand=document.getElementById('brandName');if(brand){brand.textContent=s.brand||'XDigital Brasil';if(s.logo){let img=document.querySelector('img.logo');if(!img){img=document.createElement('img');img.className='logo';brand.prepend(img)}img.src=s.logo}}const btn=document.getElementById('toggleTheme');if(btn){btn.onclick=function(){const cur=b.classList.contains('theme-dark')?'dark':'light';const next=cur==='dark'?'light':'dark';b.classList.remove('theme-light','theme-dark');b.classList.add(next==='dark'?'theme-dark':'theme-light');localStorage.setItem(k,next)}}const open=document.getElementById('openSettings');const panel=document.getElementById('settings');const close=document.getElementById('closeSettings');const save=document.getElementById('saveSettings');const setBrand=document.getElementById('setBrand');const setLogo=document.getElementById('setLogo');const setAccent=document.getElementById('setAccent');const setAccent2=document.getElementById('setAccent2');if(open&&panel){open.onclick=function(){setBrand.value=s.brand||'';setLogo.value=s.logo||'';setAccent.value=s.accent||'#0A74DA';setAccent2.value=s.accent2||'#2ECC71';panel.classList.remove('hidden')}}if(close&&panel){close.onclick=function(){panel.classList.add('hidden')}}if(save){save.onclick=function(){const newS={brand:setBrand.value||'XDigital Brasil',logo:setLogo.value||'',accent:setAccent.value||'#0A74DA',accent2:setAccent2.value||'#2ECC71'};localStorage.setItem(sKey,JSON.stringify(newS));document.documentElement.style.setProperty('--accent',newS.accent);document.documentElement.style.setProperty('--accent-2',newS.accent2);const brandEl=document.getElementById('brandName');if(brandEl){brandEl.textContent=newS.brand;if(newS.logo){let img=document.querySelector('img.logo');if(!img){img=document.createElement('img');img.className='logo';brandEl.prepend(img)}img.src=newS.logo}}panel.classList.add('hidden')}}}

function fillUF(){const u=document.getElementById('uf');if(!u)return;const arr=['','AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'];u.innerHTML='';arr.forEach(x=>{const o=document.createElement('option');o.value=x;o.textContent=x||'UF';u.appendChild(o)})}
function fillUFOrg(){const u=document.getElementById('orgUF');if(!u)return;const arr=['','AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'];u.innerHTML='';arr.forEach(x=>{const o=document.createElement('option');o.value=x;o.textContent=x||'UF';u.appendChild(o)})}
function chip(status){const s=document.createElement('span');s.className='chip '+(status==='ativo'?'ok':status==='pendente'?'warn':'muted');s.textContent=status||'desconhecido';return s}
async function openDetails(id){const panel=document.getElementById('details');const hdr=document.getElementById('d-header');const grid=document.getElementById('d-grid');const sslBody=document.getElementById('d-ssl-body');const muniBody=document.getElementById('d-muni-body');const oppBody=document.getElementById('d-opps-body');const cBody=document.getElementById('d-contacts-body');hdr.innerHTML='';grid.innerHTML='';sslBody.innerHTML='';muniBody.innerHTML='';oppBody.innerHTML='';cBody.innerHTML='';panel.classList.remove('hidden');try{const json=await fetchJSON('/api/orgaos/get?id='+id);const it=json.item||{};const title=document.createElement('div');title.innerHTML='<strong>'+ (it.nome||'') +'</strong> • '+(it.uf||'');hdr.appendChild(title);const mk=(label,val)=>{const d=document.createElement('div');d.className='card';const s=document.createElement('div');s.className='card-title';s.textContent=label;const v=document.createElement('div');v.className='card-value';if(label==='Domínio'&&val){const a=document.createElement('a');a.href='https://'+val;a.textContent=val;a.target='_blank';a.className='link';v.innerHTML='';v.appendChild(a)}else v.textContent=val||'';d.appendChild(s);d.appendChild(v);return d};const addIf=(obj,key,label)=>{if(obj && obj[key]){grid.appendChild(mk(label,obj[key]))}};grid.appendChild(mk('Tipo',it.tipo));grid.appendChild(mk('Domínio',it.dominio));grid.appendChild(mk('Site',it.site));grid.appendChild(mk('Status',it.status));addIf(it,'cnpj','CNPJ');addIf(it,'codigo_ibge','Código IBGE');addIf(it,'ibge','Código IBGE');addIf(it,'endereco','Endereço');addIf(it,'email','Email');addIf(it,'telefone','Telefone');addIf(it,'whatsapp','WhatsApp');const ssl=json.ssl||null;if(ssl){const issuer=ssl.issuer||ssl.emissor||'';const vto=ssl.valid_to||ssl.valido_ate||'';sslBody.innerHTML='Issuer: '+issuer+' • Válido até: '+vto+' • Dias: '+(ssl.dias_restantes??'')+' • Scans: '+(json.ssl_scans_count||0);}else{sslBody.innerHTML='Sem registro de SSL';}const muni=json.municipio||null;if(muni){const s=[];if(muni.nome)s.push(muni.nome);if(muni.uf)s.push(muni.uf);muniBody.innerHTML=s.join(' • ');if(muni.dominio){const a=document.createElement('a');a.href='https://'+muni.dominio;a.textContent=muni.dominio;a.target='_blank';a.className='link';muniBody.appendChild(document.createTextNode(' • '));muniBody.appendChild(a)}addIf(muni,'cnpj','CNPJ');addIf(muni,'codigo_ibge','Código IBGE');addIf(muni,'ibge','Código IBGE');addIf(muni,'email','Email');addIf(muni,'telefone','Telefone')}const opps=json.oportunidades||[];if(opps.length===0){oppBody.innerHTML='<tr><td colspan="3">Sem oportunidades</td></tr>'}else{opps.forEach(o=>{const tr=document.createElement('tr');['titulo','status','origem'].forEach(k=>{const td=document.createElement('td');td.textContent=o[k]||'';tr.appendChild(td)});oppBody.appendChild(tr)})}const contacts=json.contatos||[];if(contacts.length===0){cBody.innerHTML='<tr><td colspan="4">Sem contatos</td></tr>'}else{contacts.forEach(c=>{const tr=document.createElement('tr');['nome','cargo','email','telefone'].forEach(k=>{const td=document.createElement('td');td.textContent=c[k]||'';tr.appendChild(td)});cBody.appendChild(tr)})}const btnScan=document.getElementById('d-scan');btnScan.onclick=async function(){btnScan.disabled=true;btnScan.textContent='Scaneando...';try{await fetchJSON('/api/h/process/orgao?id='+id);const fresh=await fetchJSON('/api/orgaos/get?id='+id);const ssl2=fresh.ssl||null;const issuer2=ssl2?(ssl2.issuer||ssl2.emissor||''):'';const vto2=ssl2?(ssl2.valid_to||ssl2.valido_ate||''):'';sslBody.innerHTML=ssl2?('Issuer: '+issuer2+' • Válido até: '+vto2+' • Dias: '+(ssl2.dias_restantes??'')+' • Scans: '+(fresh.ssl_scans_count||0)):'Sem registro de SSL';const muni2=fresh.municipio||null;if(muni2){muniBody.innerHTML='';const s2=[];if(muni2.nome)s2.push(muni2.nome);if(muni2.uf)s2.push(muni2.uf);muniBody.innerHTML=s2.join(' • ');if(muni2.dominio){const a=document.createElement('a');a.href='https://'+muni2.dominio;a.textContent=muni2.dominio;a.target='_blank';a.className='link';muniBody.appendChild(document.createTextNode(' • '));muniBody.appendChild(a)}}}finally{btnScan.disabled=false;btnScan.textContent='Scan SSL'}};const btnClose=document.getElementById('d-close');btnClose.onclick=function(){panel.classList.add('hidden')}}catch(e){panel.classList.add('hidden')}}
function renderSearch(rows){const t=document.getElementById('searchResults');const b=t.querySelector('tbody');b.innerHTML='';rows.forEach(r=>{const tr=document.createElement('tr');tr.style.cursor='pointer';tr.onclick=function(){openDetails(parseInt(r.id))};const tdNome=document.createElement('td');tdNome.textContent=r.nome||'';const tdUF=document.createElement('td');tdUF.textContent=r.uf||'';const tdDom=document.createElement('td');const v=r.dominio||'';if(v){const a=document.createElement('a');a.href='https://'+v;a.textContent=v;a.target='_blank';a.className='link';tdDom.appendChild(a)}else{tdDom.textContent='';}const tdTipo=document.createElement('td');tdTipo.textContent=r.tipo||'';const tdStatus=document.createElement('td');tdStatus.appendChild(chip(r.status));tr.appendChild(tdNome);tr.appendChild(tdUF);tr.appendChild(tdDom);tr.appendChild(tdTipo);tr.appendChild(tdStatus);b.appendChild(tr)})}
function initSearch(){fillUF();const f=document.getElementById('searchForm');if(!f)return;f.onsubmit=async function(e){e.preventDefault();const q=document.getElementById('q').value.trim();const uf=document.getElementById('uf').value.trim();const tipo=document.getElementById('tipo').value.trim();const params=new URLSearchParams();params.set('limit','20');if(q)params.set('q',q);if(uf)params.set('uf',uf);if(tipo)params.set('tipo',tipo);const t=document.getElementById('searchResults');const b=t.querySelector('tbody');b.innerHTML='<tr><td colspan="5">Carregando...</td></tr>';try{const res=await fetch('/api/orgaos/search?'+params.toString());const json=await res.json();renderSearch(json.items||[])}catch(err){b.innerHTML='<tr><td colspan="5">Erro ao buscar</td></tr>'}}}
function fillUFSelect(id){const u=document.getElementById(id);if(!u)return;const arr=['','AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO'];u.innerHTML='';arr.forEach(x=>{const o=document.createElement('option');o.value=x;o.textContent=x||'UF';u.appendChild(o)})}
function initIA(){fillUFSelect('iaUF');fillUFSelect('iaBatchUF');const f=document.getElementById('iaForm');if(f){f.onsubmit=async function(e){e.preventDefault();const nome=document.getElementById('iaNome').value.trim();const tipo=document.getElementById('iaTipo').value.trim();const uf=document.getElementById('iaUF').value.trim();const dominio=document.getElementById('iaDominio').value.trim();const site=document.getElementById('iaSite').value.trim();const body={tipo,nome,uf,dominio,site,scan:true};const r=await fetch('/api/orgaos/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});const j=await r.json();const tbl=document.getElementById('iaResults');const b=tbl.querySelector('tbody');if(j && j.id){b.innerHTML='<tr><td colspan="4">Processado órgão '+j.id+'</td></tr>'}else{b.innerHTML='<tr><td colspan="4">Erro ao cadastrar</td></tr>'}}}
const tbl=document.getElementById('iaResults');const b=tbl?tbl.querySelector('tbody'):null;let iaOffset=0;const runBtn=document.getElementById('iaBatchRun');async function runBatch(){if(!b)return;runBtn.disabled=true;runBtn.textContent='Processando...';const uf=document.getElementById('iaBatchUF').value.trim();const tipo=document.getElementById('iaBatchTipo').value.trim();const limit=parseInt(document.getElementById('iaBatchLimit').value||'50');const p=new URLSearchParams();p.set('limit',String(limit));p.set('offset',String(iaOffset));if(uf)p.set('uf',uf);if(tipo)p.set('tipo',tipo);const res=await fetch('/api/ia/analyze-batch?'+p.toString());const j=await res.json();b.innerHTML='';(j.items||[]).forEach(it=>{const tr=document.createElement('tr');const tdA=document.createElement('td');tdA.textContent=String(it.orgao_id);const tdB=document.createElement('td');tdB.textContent=it.dominio||'';const tdC=document.createElement('td');tdC.textContent=(it.risco&&it.risco.descricao)?it.risco.descricao:(it.risco||'');const tdD=document.createElement('td');tdD.textContent=it.ok?'OK':'ERRO';tr.appendChild(tdA);tr.appendChild(tdB);tr.appendChild(tdC);tr.appendChild(tdD);b.appendChild(tr)});runBtn.disabled=false;runBtn.textContent='Analisar em Lote';}
if(runBtn){runBtn.onclick=function(){iaOffset=0;runBatch()}}
const prev=document.getElementById('iaPrev');const next=document.getElementById('iaNext');if(prev){prev.onclick=function(){const limit=parseInt(document.getElementById('iaBatchLimit').value||'50');iaOffset=Math.max(iaOffset-limit,0);runBatch()}}if(next){next.onclick=function(){const limit=parseInt(document.getElementById('iaBatchLimit').value||'50');iaOffset=iaOffset+limit;runBatch()}}
}
let orgOffset=0;let oppOffset=0;let auditOffset=0;function getNum(id,def){const el=document.getElementById(id);const v=parseInt((el&&el.value)||String(def));return isNaN(v)?def:v}function setRange(elId,from,to,total){const el=document.getElementById(elId);if(!el)return;if(total===0){el.textContent='0 de 0';return}el.textContent=from+'–'+to+' de '+total}
async function loadOrgaos(){const size=getNum('orgPageSize',10);const uf=(document.getElementById('orgUF')&&document.getElementById('orgUF').value.trim())||'';const tipo=(document.getElementById('orgTipo')&&document.getElementById('orgTipo').value.trim())||'';const esfera=(document.getElementById('orgEsfera')&&document.getElementById('orgEsfera').value.trim())||'';const p=new URLSearchParams();p.set('limit',String(size));p.set('offset',String(orgOffset));if(uf)p.set('uf',uf);if(tipo)p.set('tipo',tipo);if(esfera)p.set('esfera',esfera);p.set('has_ssl','1');const o=await fetchJSON('/api/orgaos/search?'+p.toString());const items=o.items||[];const total=o.total||items.length;const t=document.getElementById('orgaos');const b=t.querySelector('tbody');b.innerHTML='';items.forEach(it=>{const tr=document.createElement('tr');tr.style.cursor='pointer';tr.onclick=function(){openDetails(parseInt(it.id))};const tdNome=document.createElement('td');tdNome.textContent=it.nome||'';const tdUF=document.createElement('td');tdUF.textContent=it.uf||'';const tdDom=document.createElement('td');const v=it.dominio||'';if(v){const a=document.createElement('a');a.href='https://'+v;a.textContent=v;a.target='_blank';a.className='link';tdDom.appendChild(a)}else{tdDom.textContent='';}const tdIss=document.createElement('td');tdIss.textContent=it.issuer||'';const tdFrom=document.createElement('td');tdFrom.textContent=it.valid_from||'';const tdVto=document.createElement('td');tdVto.textContent=it.valid_to||'';const tdDias=document.createElement('td');tdDias.textContent=(it.dias_restantes===null||it.dias_restantes===undefined)?'':String(it.dias_restantes);const tdSSL=document.createElement('td');tdSSL.textContent=it.ssl_status||'';const tdEmail=document.createElement('td');tdEmail.textContent=it.email||'';const tdTel=document.createElement('td');tdTel.textContent=it.telefone||'';tr.appendChild(tdNome);tr.appendChild(tdUF);tr.appendChild(tdDom);tr.appendChild(tdIss);tr.appendChild(tdFrom);tr.appendChild(tdVto);tr.appendChild(tdDias);tr.appendChild(tdSSL);tr.appendChild(tdEmail);tr.appendChild(tdTel);b.appendChild(tr)});const from=total===0?0:(orgOffset+1);const to=Math.min(orgOffset+size,total);setRange('orgRange',from,to,total);const prev=document.getElementById('orgPrev');const next=document.getElementById('orgNext');if(prev)prev.disabled=orgOffset<=0;if(next)next.disabled=(orgOffset+size)>=total}
let sslOffset=0;function renderSSL(rows){const t=document.getElementById('sslList');const b=t.querySelector('tbody');b.innerHTML='';rows.forEach(r=>{const tr=document.createElement('tr');const tdDom=document.createElement('td');const v=r.dominio||'';if(v){const a=document.createElement('a');a.href='https://'+v;a.textContent=v;a.target='_blank';a.className='link';tdDom.appendChild(a)}else{tdDom.textContent='';}const tdCN=document.createElement('td');tdCN.textContent=r.cn||'';const tdIssuer=document.createElement('td');tdIssuer.textContent=r.issuer||'';const tdFrom=document.createElement('td');tdFrom.textContent=r.valid_from||'';const tdVto=document.createElement('td');tdVto.textContent=r.valid_to||'';const tdDias=document.createElement('td');tdDias.textContent=(r.dias_restantes===null||r.dias_restantes===undefined)?'':String(r.dias_restantes);const tdStatus=document.createElement('td');tdStatus.textContent=r.status||'';const tdAt=document.createElement('td');tdAt.textContent=r.last_scan_at||'';tr.appendChild(tdDom);tr.appendChild(tdCN);tr.appendChild(tdIssuer);tr.appendChild(tdFrom);tr.appendChild(tdVto);tr.appendChild(tdDias);tr.appendChild(tdStatus);tr.appendChild(tdAt);b.appendChild(tr)})}
async function loadSSL(){const size=getNum('sslPageSize',10);const p=new URLSearchParams();p.set('limit',String(size));p.set('offset',String(sslOffset));const s=await fetchJSON('/api/ssl/scans/list?'+p.toString());const items=s.items||[];const total=items.length;renderSSL(items);const from=total===0?0:(sslOffset+1);const to=Math.min(sslOffset+size,total);setRange('sslRange',from,to,total);const prev=document.getElementById('sslPrev');const next=document.getElementById('sslNext');if(prev)prev.disabled=sslOffset<=0;if(next)next.disabled=(sslOffset+size)>=total}
async function loadOpps(){const size=getNum('oppsPageSize',10);const p=new URLSearchParams();p.set('limit',String(size));p.set('offset',String(oppOffset));const o=await fetchJSON('/api/orgaos/list?'+p.toString());const items=o.items||[];const total=o.total||items.length;const t=document.getElementById('opps');const b=t.querySelector('tbody');b.innerHTML='';items.forEach(it=>{const tr=document.createElement('tr');const tdNome=document.createElement('td');tdNome.textContent=it.nome||'';const tdUF=document.createElement('td');tdUF.textContent=it.uf||'';const tdDom=document.createElement('td');const v=it.dominio||'';if(v){const a=document.createElement('a');a.href='https://'+v;a.textContent=v;a.target='_blank';a.className='link';tdDom.appendChild(a)}else{tdDom.textContent='';}const tdAct=document.createElement('td');const btnReu=document.createElement('button');btnReu.className='btn';btnReu.textContent='Reunião';btnReu.onclick=async function(){btnReu.disabled=true;btnReu.textContent='...';try{await fetch('/api/crm/oportunidades/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({orgao_id:parseInt(it.id),titulo:'Reunião com '+(it.nome||''),status:'reuniao',origem:'manual'})});}catch(e){}btnReu.disabled=false;btnReu.textContent='Reunião'};const btnCont=document.createElement('button');btnCont.className='btn';btnCont.textContent='Contato';btnCont.onclick=async function(){btnCont.disabled=true;btnCont.textContent='...';try{await fetch('/api/crm/oportunidades/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({orgao_id:parseInt(it.id),titulo:'Contato: '+(it.nome||''),status:'contato',origem:'manual'})});}catch(e){}btnCont.disabled=false;btnCont.textContent='Contato'};const btnVenda=document.createElement('button');btnVenda.className='btn';btnVenda.textContent='Venda';btnVenda.onclick=async function(){btnVenda.disabled=true;btnVenda.textContent='...';try{await fetch('/api/crm/oportunidades/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({orgao_id:parseInt(it.id),titulo:'Venda: '+(it.nome||''),status:'venda',origem:'manual'})});}catch(e){}btnVenda.disabled=false;btnVenda.textContent='Venda'};tdAct.appendChild(btnReu);tdAct.appendChild(document.createTextNode(' '));tdAct.appendChild(btnCont);tdAct.appendChild(document.createTextNode(' '));tdAct.appendChild(btnVenda);tr.appendChild(tdNome);tr.appendChild(tdUF);tr.appendChild(tdDom);tr.appendChild(tdAct);b.appendChild(tr)});const from=total===0?0:(oppOffset+1);const to=Math.min(oppOffset+size,total);setRange('oppsRange',from,to,total);const prev=document.getElementById('oppsPrev');const next=document.getElementById('oppsNext');if(prev)prev.disabled=oppOffset<=0;if(next)next.disabled=(oppOffset+size)>=total}
async function loadAudit(){const size=getNum('auditPageSize',10);const p=new URLSearchParams();p.set('limit',String(size));p.set('offset',String(auditOffset));const a=await fetchJSON('/api/audit/list?'+p.toString());const items=a.items||[];const total=a.total||items.length;renderTable(document.getElementById('audit'),items,['entity_type','entity_id','action','payload_json','created_at']);const from=total===0?0:(auditOffset+1);const to=Math.min(auditOffset+size,total);setRange('auditRange',from,to,total);const prev=document.getElementById('auditPrev');const next=document.getElementById('auditNext');if(prev)prev.disabled=auditOffset<=0;if(next)next.disabled=(auditOffset+size)>=total}
async function load(){initTheme();try{const m=await fetchJSON('/api/metrics/overview');setMetrics(m);setBadges(m)}catch(e){}fillUFOrg();try{await loadOrgaos()}catch(e){}try{await loadOpps()}catch(e){}initSearch();initIA();fillUFSelect('sslUF');try{await loadSSL()}catch(e){}const orgPrev=document.getElementById('orgPrev');const orgNext=document.getElementById('orgNext');const orgSize=document.getElementById('orgPageSize');const orgUF=document.getElementById('orgUF');const orgTipo=document.getElementById('orgTipo');const orgEsfera=document.getElementById('orgEsfera');if(orgPrev){orgPrev.onclick=function(){const size=getNum('orgPageSize',10);orgOffset=Math.max(0,orgOffset-size);loadOrgaos()}}if(orgNext){orgNext.onclick=function(){const size=getNum('orgPageSize',10);orgOffset=orgOffset+size;loadOrgaos()}}if(orgSize){orgSize.onchange=function(){orgOffset=0;loadOrgaos()}}if(orgUF){orgUF.onchange=function(){orgOffset=0;loadOrgaos()}}if(orgTipo){orgTipo.onchange=function(){orgOffset=0;loadOrgaos()}}if(orgEsfera){orgEsfera.onchange=function(){orgOffset=0;loadOrgaos()}}const oppsPrev=document.getElementById('oppsPrev');const oppsNext=document.getElementById('oppsNext');const oppsSize=document.getElementById('oppsPageSize');const oppsStatus=document.getElementById('oppsStatus');if(oppsPrev){oppsPrev.onclick=function(){const size=getNum('oppsPageSize',10);oppOffset=Math.max(0,oppOffset-size);loadOpps()}}if(oppsNext){oppsNext.onclick=function(){const size=getNum('oppsPageSize',10);oppOffset=oppOffset+size;loadOpps()}}if(oppsSize){oppsSize.onchange=function(){oppOffset=0;loadOpps()}}if(oppsStatus){oppsStatus.onchange=function(){oppOffset=0;loadOpps()}}const sslPrev=document.getElementById('sslPrev');const sslNext=document.getElementById('sslNext');const sslUF=document.getElementById('sslUF');const sslEsfera=document.getElementById('sslEsfera');const sslStatus=document.getElementById('sslStatus');const sslDaysMax=document.getElementById('sslDaysMax');const sslSize=document.getElementById('sslPageSize');const sslBatch=document.getElementById('sslBatch');const sslResolve=document.getElementById('sslResolve');const sslCriteria=document.getElementById('sslCriteria');if(sslPrev){sslPrev.onclick=function(){const size=getNum('sslPageSize',10);sslOffset=Math.max(0,sslOffset-size);loadSSL()}}if(sslNext){sslNext.onclick=function(){const size=getNum('sslPageSize',10);sslOffset=sslOffset+size;loadSSL()}}if(sslUF){sslUF.onchange=function(){sslOffset=0;loadSSL()}}if(sslEsfera){sslEsfera.onchange=function(){sslOffset=0;loadSSL()}}if(sslStatus){sslStatus.onchange=function(){sslOffset=0;loadSSL()}}if(sslDaysMax){sslDaysMax.onchange=function(){sslOffset=0;loadSSL()}}if(sslSize){sslSize.onchange=function(){sslOffset=0;loadSSL()}}if(sslBatch){sslBatch.onclick=async function(){const domains=(lastSSLItems||[]).map(r=>r.dominio).filter(Boolean);if(domains.length===0)return;sslBatch.disabled=true;sslBatch.textContent='Processando...';try{await fetch('/api/ssl/scan_batch',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({domains})});}catch(e){}sslBatch.disabled=false;sslBatch.textContent='Scan em Lote';loadSSL()}}if(sslResolve){sslResolve.onclick=async function(){const uf=(document.getElementById('sslUF')&&document.getElementById('sslUF').value.trim())||'';const esfera=(document.getElementById('sslEsfera')&&document.getElementById('sslEsfera').value.trim())||'';sslResolve.disabled=true;sslResolve.textContent='Processando...';try{await fetch('/api/domains/resolve_missing',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uf,esfera,limit:200})});}catch(e){}sslResolve.disabled=false;sslResolve.textContent='Resolver Domínios';loadSSL()}}if(sslCriteria){sslCriteria.onclick=async function(){const uf=(document.getElementById('sslUF')&&document.getElementById('sslUF').value.trim())||'';const esfera=(document.getElementById('sslEsfera')&&document.getElementById('sslEsfera').value.trim())||'';sslCriteria.disabled=true;sslCriteria.textContent='Processando...';try{await fetch('/api/ssl/scan_criteria',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({uf,esfera,limit:200})});}catch(e){}sslCriteria.disabled=false;sslCriteria.textContent='Scan por Critérios';loadSSL()}}}
document.addEventListener('DOMContentLoaded',load)
function initNav(){const items=document.querySelectorAll('.nav-item');const sections=['section-dashboard','section-search','section-orgaos','section-ssl','section-ssl-scans','section-opps','section-audit'];function show(id){sections.forEach(s=>{const el=document.getElementById(s);if(!el)return;el.classList.toggle('hidden',s!==id)});items.forEach(i=>{const t=i.getAttribute('data-target');i.classList.toggle('active',t===id)});}items.forEach(i=>{i.onclick=function(){const act=i.getAttribute('data-action');if(act==='openSettings'){const p=document.getElementById('settings');p.classList.remove('hidden');return}const t=i.getAttribute('data-target');if(t)show(t)}});show('section-dashboard');const toggle=document.getElementById('toggleSidebar');if(toggle){toggle.onclick=function(){document.getElementById('sidebar').classList.toggle('hidden')}}}
document.addEventListener('DOMContentLoaded',initNav)
document.addEventListener('DOMContentLoaded',function(){try{const sizeEl=document.getElementById('sslScansPageSize');const prev=document.getElementById('sslScansPrev');const next=document.getElementById('sslScansNext');loadSSLScans();if(sizeEl){sizeEl.onchange=function(){sslScansOffset=0;loadSSLScans()}}if(prev){prev.onclick=function(){const size=getNum('sslScansPageSize',10);sslScansOffset=Math.max(0,sslScansOffset-size);loadSSLScans()}}if(next){next.onclick=function(){const size=getNum('sslScansPageSize',10);sslScansOffset=sslScansOffset+size;loadSSLScans()}}}catch(e){}})
async function loadSSLScans(){const size=getNum('sslScansPageSize',10);const p=new URLSearchParams();p.set('limit',String(size));p.set('offset',String(sslScansOffset));const s=await fetchJSON('/api/ssl/scans/list?'+p.toString());const items=s.items||[];const total=items.length;const t=document.getElementById('sslScans');const b=t.querySelector('tbody');b.innerHTML='';items.forEach(r=>{const tr=document.createElement('tr');const tdNome=document.createElement('td');tdNome.textContent=r.nome||'';const tdUF=document.createElement('td');tdUF.textContent=r.uf||'';const tdDom=document.createElement('td');const v=r.dominio||'';if(v){const a=document.createElement('a');a.href='https://'+v;a.textContent=v;a.target='_blank';a.className='link';tdDom.appendChild(a)}else{tdDom.textContent='';}const tdSt=document.createElement('td');tdSt.textContent=r.status||'';const tdVto=document.createElement('td');tdVto.textContent=r.valid_to||'';const tdDias=document.createElement('td');tdDias.textContent=(r.dias_restantes===null||r.dias_restantes===undefined)?'':String(r.dias_restantes);const tdAt=document.createElement('td');tdAt.textContent=r.last_scan_at||'';tr.appendChild(tdNome);tr.appendChild(tdUF);tr.appendChild(tdDom);tr.appendChild(tdSt);tr.appendChild(tdVto);tr.appendChild(tdDias);tr.appendChild(tdAt);b.appendChild(tr)});const from=total===0?0:(sslScansOffset+1);const to=Math.min(sslScansOffset+size,total);setRange('sslScansRange',from,to,total);const prev=document.getElementById('sslScansPrev');const next=document.getElementById('sslScansNext');if(prev)prev.disabled=sslScansOffset<=0;if(next)next.disabled=(sslScansOffset+size)>=total}
document.addEventListener('DOMContentLoaded',function(){try{loadAudit()}catch(e){}const auditPrev=document.getElementById('auditPrev');const auditNext=document.getElementById('auditNext');const auditSize=document.getElementById('auditPageSize');if(auditPrev){auditPrev.onclick=function(){const size=getNum('auditPageSize',10);auditOffset=Math.max(0,auditOffset-size);loadAudit()}}if(auditNext){auditNext.onclick=function(){const size=getNum('auditPageSize',10);auditOffset=auditOffset+size;loadAudit()}}if(auditSize){auditSize.onchange=function(){auditOffset=0;loadAudit()}}})
